<!DOCTYPE html>
<html lang="en-US">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Nodejs异步流程控制Async | 粉丝日志</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="pingback" href="http://blog.fens.me/xmlrpc.php" />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="粉丝日志 &raquo; Feed" href="http://blog.fens.me/feed/" />
<link rel="alternate" type="application/rss+xml" title="粉丝日志 &raquo; Comments Feed" href="http://blog.fens.me/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="粉丝日志 &raquo; Nodejs异步流程控制Async Comments Feed" href="http://blog.fens.me/nodejs-async/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/blog.fens.me\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.7.4"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='default-css'  href='http://blog.fens.me/wp-content/themes/silesia/style.css' type='text/css' media='all' />
<!--[if IE 7]>
<link rel='stylesheet' id='silesia-ie7-css'  href='http://blog.fens.me/wp-content/themes/silesia/ie7.css' type='text/css' media='all' />
<![endif]-->
<!--[if IE 6]>
<link rel='stylesheet' id='silesia-ie6-css'  href='http://blog.fens.me/wp-content/themes/silesia/ie6.css' type='text/css' media='all' />
<![endif]-->
<script type='text/javascript' src='http://blog.fens.me/wp-includes/js/jquery/jquery.js?ver=1.12.4'></script>
<script type='text/javascript' src='http://blog.fens.me/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript' src='http://blog.fens.me/wp-content/themes/silesia/js/jquery.cycle.all.min.js'></script>
<script type='text/javascript' src='http://blog.fens.me/wp-content/themes/silesia/js/load.js'></script>
<link rel='https://api.w.org/' href='http://blog.fens.me/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://blog.fens.me/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://blog.fens.me/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='用Nodejs连接MySQL' href='http://blog.fens.me/nodejs-mysql-intro/' />
<link rel='next' title='R和JSON的傻瓜式编程' href='http://blog.fens.me/r-json-rjson/' />
<meta name="generator" content="WordPress 4.7.4" />
<link rel="canonical" href="http://blog.fens.me/nodejs-async/" />
<link rel='shortlink' href='http://blog.fens.me/?p=2357' />
<link rel="alternate" type="application/json+oembed" href="http://blog.fens.me/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fblog.fens.me%2Fnodejs-async%2F" />
<link rel="alternate" type="text/xml+oembed" href="http://blog.fens.me/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fblog.fens.me%2Fnodejs-async%2F&#038;format=xml" />
<meta name="template" content="silesia 1.0.6" />
<meta name="generator" content="NattyWP Framework Version 2.1.5" />
<meta name="keywords" content="async,nodejs,work flow,sync" />
<meta name="description" content="跨界的IT博客，核心IT技术包括：Hadoop, R, RHadoop, Nodejs, AngularJS, KVM, NoSQL, IT金融" />
<link href="http://blog.fens.me/wp-content/uploads/2013/05/favicon.ico" rel="shortcut icon" type="image/x-icon" />
<link rel="stylesheet" type="text/css" href="http://blog.fens.me/wp-content/themes/silesia/functions/css/shortcodes.css" media="screen" /><script type="text/javascript" src="http://blog.fens.me/wp-content/themes/silesia/functions/js/shortcode.js"></script><style type="text/css">
	#header {
		background-color: #F7F7F7;
	}
	#main-nav, #main-nav a#control, #link-sidebar h2 {
		color: #30353A;
	}
	#header .tagline {
		color: #BBBBBB;
	}
	#main-nav {
		background-color: #527F8D;
	}
	#main-nav, #main-nav a#control, #link-sidebar h2 {
		color: #ffffff;
	}
	#link-sidebar a, #main-nav a#control:hover {
		color: #D8F1FA;
	}
	#link-sidebar ul li.widget a:hover {
		color: #ffffff;
	}
	.hentry h2, .hentry h2 a, .singlepage .post h2, .singlepage .page.comments h2 {
		color: #434343;
	}
	.p-cont .entry, .singlepage .entry {
		color: #4D4D4F;
	}
	.post a, .page.comments a {
		color: #0E73B8;
	}
	.post a:hover, .page.comments a:hover, .hentry h2 a:hover {
		color: #ff0505;
	}
	#sidebar h2 {
		color: #4D4D4F;
	}
	#sidebar {
		color: #555555;
	}
	#sidebar a {
		color: #0E73B8;
	}
	#sidebar a:hover {
		color: #ff0505;
	}
</style><style type="text/css">
    #header .triangle {border-left: 7px solid #527F8D;}
  </style><!--[if IE 6]>
    <script type="text/javascript" src="http://blog.fens.me/wp-content/themes/silesia/js/ie6/warning.js"></script>
    <script type="text/javascript" charset="utf-8">/*<![CDATA[*/window.onload=function(){e("http://blog.fens.me/wp-content/themes/silesia/js/ie6/")}/*]]>*/</script>
<![endif]-->		<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
		<style type="text/css" id="custom-background-css">
body.custom-background { background-color: #ffffff; }
</style>
</head>

<body class="post-template-default single single-post postid-2357 single-format-standard custom-background">
<div id="main-nav">
  <div id="link-sidebar">
    <ul>
                      <li class="widget png_scale" id="widget_categories">
          <h2 class="blocktitle"><span>Categories</span></h2>	
          <ul>
              	<li class="cat-item cat-item-9"><a href="http://blog.fens.me/category/datagurucn/" >Dataguru作业</a>
</li>
	<li class="cat-item cat-item-1"><a href="http://blog.fens.me/category/hadoop-action/" >Hadoop实践</a>
</li>
	<li class="cat-item cat-item-65"><a href="http://blog.fens.me/category/it%e7%9b%b8%e5%85%b3%e7%9f%a5%e8%af%86/" >IT相关知识</a>
</li>
	<li class="cat-item cat-item-55"><a href="http://blog.fens.me/category/javascript%e8%af%ad%e8%a8%80%e5%ae%9e%e8%b7%b5/" >Javascript语言实践</a>
</li>
	<li class="cat-item cat-item-3"><a href="http://blog.fens.me/category/java-lang/" >JAVA语言实践</a>
</li>
	<li class="cat-item cat-item-8"><a href="http://blog.fens.me/category/r-lang/" >R语言实践</a>
</li>
	<li class="cat-item cat-item-217"><a href="http://blog.fens.me/category/seo%e4%bc%98%e5%8c%96/" >SEO优化</a>
</li>
	<li class="cat-item cat-item-356"><a href="http://blog.fens.me/category/%e5%85%b6%e4%bb%96%e8%af%ad%e8%a8%80/" >其他语言</a>
</li>
	<li class="cat-item cat-item-774"><a href="http://blog.fens.me/category/%e5%88%9b%e4%b8%9a/" >创业</a>
</li>
	<li class="cat-item cat-item-233"><a href="http://blog.fens.me/category/%e5%8f%af%e8%a7%86%e5%8c%96%e6%8a%80%e6%9c%af/" >可视化技术</a>
</li>
	<li class="cat-item cat-item-20"><a href="http://blog.fens.me/category/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f/" >操作系统</a>
</li>
	<li class="cat-item cat-item-29"><a href="http://blog.fens.me/category/%e6%95%b0%e6%8d%ae%e5%ba%93/" >数据库</a>
</li>
	<li class="cat-item cat-item-30"><a href="http://blog.fens.me/category/%e6%95%b0%e6%8d%ae%e6%8c%96%e6%8e%98/" >数据挖掘</a>
</li>
	<li class="cat-item cat-item-10"><a href="http://blog.fens.me/category/%e6%99%92%e7%b2%89%e4%b8%9d/" >晒粉丝</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://blog.fens.me/category/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1/" >架构设计</a>
</li>
	<li class="cat-item cat-item-113"><a href="http://blog.fens.me/category/%e6%b4%bb%e5%8a%a8%e8%81%9a%e4%bc%9a/" >活动聚会</a>
</li>
	<li class="cat-item cat-item-598"><a href="http://blog.fens.me/category/%e6%b8%b8%e6%88%8f/" >游戏</a>
</li>
	<li class="cat-item cat-item-24"><a href="http://blog.fens.me/category/%e7%a8%8b%e5%ba%8f%e7%ae%97%e6%b3%95/" >程序算法</a>
</li>
	<li class="cat-item cat-item-117"><a href="http://blog.fens.me/category/%e7%bd%91%e7%bb%9c%e6%8a%80%e6%9c%af/" >网络技术</a>
</li>
	<li class="cat-item cat-item-76"><a href="http://blog.fens.me/category/%e8%99%9a%e6%8b%9f%e5%8c%96%e5%ae%9e%e8%b7%b5/" >虚拟化实践</a>
</li>
	<li class="cat-item cat-item-184"><a href="http://blog.fens.me/category/%e9%87%91%e8%9e%8d/" >金融</a>
</li>
	<li class="cat-item cat-item-32"><a href="http://blog.fens.me/category/%e9%9d%a2%e8%af%95/" >面试</a>
</li>
	<li class="cat-item cat-item-44"><a href="http://blog.fens.me/category/%e9%bb%91%e5%ae%a2%e6%94%bb%e9%98%b2/" >黑客攻防</a>
</li>
          </ul>		
        </li>
                <li id="twitterWidget" class="widget png_scale">	
          <div id="twitter">
            <h2 class="blocktitle"><span>Twitter Updates</span></h2>		<ul id="twitter_update_list"><li></li></ul>
            <!--<script type="text/javascript" src="http://twitter.com/javascripts/blogger.js"></script>-->
            <!--<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/nattywp.json?callback=twitterCallback2&amp;count=1"></script>-->
            <div class="dasheddivider"></div>
            <p align="right"><a href="http://www.twitter.com/nattywp/" class="rightlink png_crop">Follow us on Twitter</a></p>
        </div>
        </li>   
           
    </ul>
  </div>
  <a id="control" href="#">+</a>
</div>

<div id="main-wrapper">
<div id="header">
  <div class="wrapper">
    <div class="triangle"></div>
    <div class="logo-block">
    <div class="logo">
    <ul><li><a class="logo-title shadowed" href="http://blog.fens.me" rel="home" title="粉丝日志">粉丝日志</a></li></ul> 
    </div>
  <div class="tagline">跨界的IT博客|Hadoop家族, R, RHadoop, Nodejs, AngularJS, NoSQL, IT金融</div></div>
  
    <div class="clear"></div>
  </div>
</div>

<div id="cnt" class="wrapper">
  <div class="top">
    <ul id="crumbs"><li class="first"><a href="http://blog.fens.me" id="home-img"></a></li><li><a href="http://blog.fens.me/category/javascript%e8%af%ad%e8%a8%80%e5%ae%9e%e8%b7%b5/">Javascript语言实践</a> &raquo; </li><li>Nodejs异步流程控制Async</li></ul><div style="float:right;margin-right:10px;font-size:14px;"><ul style="list-style-type: none;"><li style="list-style-type: none;float: left;line-height: 24px;margin: 0 7px;"><a href="http://www.fens.me/" target="_blank">@晒粉丝</a></li><li style="list-style-type: none;float: left;line-height: 24px;margin: 0 7px;"><a href="http://apps.weibo.com/chinaweatherapp" target="_blank">@每日中国天气</a></li></ul></div>    <div class="clear"></div>            
  </div> <!-- END top -->


<!-- END Header --><div class="narrowcolumn singlepage">
              <div class="post-2357 post type-post status-publish format-standard hentry category-javascript category-19 tag-async tag-nodejs tag-sync tag-work-flow">
         <div class="post-meta">
          <a href="http://blog.fens.me/nodejs-async/" title="Nodejs异步流程控制Async" class="ms"></a>
          <h5>Posted:</h5>
          <span class="date">Sep 13, 2013</span>
          <h5>Tags:</h5><div class="tags"><a href="http://blog.fens.me/tag/async/" rel="tag">async</a><a href="http://blog.fens.me/tag/nodejs/" rel="tag">nodejs</a><a href="http://blog.fens.me/tag/sync/" rel="tag">sync</a><a href="http://blog.fens.me/tag/work-flow/" rel="tag">work flow</a></div>          <h5>Comments:</h5>
          <span class="comment"><a href="http://blog.fens.me/nodejs-async/#comments"><span class="dsq-postid" data-dsqidentifier="2357 http://blog.fens.me/?p=2357">36 Comments</span></a></span>
                   </div>
         
         <div class="p-cont">
            <h2>Nodejs异步流程控制Async</h2>
            <div class="entry">
                            <p><a title="从零开始nodejs系列文章" href="http://blog.fens.me/series-nodejs/" target="_blank">从零开始nodejs系列文章</a>，将介绍如何利Javascript做为服务端脚本，通过Nodejs框架web开发。Nodejs框架是基于V8的引擎，是目前速度最快的Javascript引擎。chrome浏览器就基于V8，同时打开20-30个网页都很流畅。Nodejs标准的web开发框架Express，可以帮助我们迅速建立web站点，比起PHP的开发效率更高，而且学习曲线更低。非常适合小型网站，个性化网站，我们自己的Geek网站！！</p>
<p><strong>关于作者</strong></p>
<ul>
<li>张丹(Conan), 程序员Java,R,PHP,Javascript</li>
<li>weibo：@Conan_Z</li>
<li>blog: <a title="粉丝日志|跨界的IT博客" href="http://blog.fens.me/" target="_blank">http://blog.fens.me</a></li>
<li>email: bsspirit@gmail.com</li>
</ul>
<p><strong>转载请注明出处：</strong><br />
<a title="Nodejs异步流程控制Async" href="http://blog.fens.me/nodejs-async/" target="_blank">http://blog.fens.me/nodejs-async/</a></p>
<p><a href="http://blog.fens.me/wp-content/uploads/2013/09/nodejs-async.png"><img src="http://blog.fens.me/wp-content/uploads/2013/09/nodejs-async.png" alt="nodejs-async" width="600" height="400" class="alignnone size-full wp-image-2406" /></a></p>
<p><strong>前言</strong></p>
<p>Nodejs框架类库很多，功能相近的框架，本来只打算学一种写一种。之前写过流程控制框架<a title="wind.js助力异步编程" href="http://blog.fens.me/nodejs-async-windjs/" target="_blank">windjs文章</a>，本来是想着要支持一下“国人框架”。无奈啊，作者竟然放弃了维护，国人真的不靠谱啊！</p>
<p>“流程控制”本来是件比较简单的事，但是由于Nodejs的异步架构的实现方法，对于需要同步的业务逻辑，实现起来就比较麻烦。嵌套3-4层，代码就会变得的支离破碎了！</p>
<p>今天就遇到了一个业务逻辑，连续对数据库操作，前后有依赖。让我们看看Async是如何解决问题的。</p>
<p>不用不知道，一用真强大！！</p>
<p><strong>目录</strong></p>
<ol>
<li>Async介绍</li>
<li>Async安装</li>
<li>Async函数介绍</li>
<li>async_demo使用介绍</li>
<li>场景：对数据库的连续操作</li>
<li>async_demo我的分支</li>
</ol>
<h2>1. Async介绍</h2>
<p>Async是一个流程控制工具���，提供了直接而强大的异步功能。基于Javascript为Node.js设计，同时也可以直接在浏览器中使用。</p>
<p>Async提供了大约20个函数，包括常用的 map, reduce, filter, forEach 等，异步流程控制模式包括，串行(series)，并行(parallel)，瀑布(waterfall)等。</p>
<p>项目地址：<a title="async" href="https://github.com/caolan/async" target="_blank">https://github.com/caolan/async</a></p>
<h2>2. Async安装</h2>
<p><strong>我的系统环境</strong></p>
<ul>
<li>win7 64bit</li>
<li>Nodejs:v0.10.5</li>
<li>Npm:1.2.19</li>
<li>MySQL:Server version: 5.6.11 MySQL Community Server (GPL)</li>
</ul>
<p><strong>我们做实验时，安装async有两个方式:</strong></p>
<ul>
<li>1. 独立安装async</li>
<li>2. 下载async demo代码安装</li>
</ul>
<p>我建议大家用第二种方式安装，这样子实例的代码就都有了。</p>
<p><strong>1). 独立安装async</strong></p>
<pre><code>
~ D:\workspace\javascript>mkdir nodejs-async && cd nodejs-async
~ D:\workspace\javascript\nodejs-async>npm install async
npm http GET https://registry.npmjs.org/async
npm http 304 https://registry.npmjs.org/async
async@0.2.9 node_modules\async
</code></pre>
<p>打开网页,参照示例学习：<a target="_blank" href="https://github.com/bsspirit/async_demo" ref="nofollow">https://github.com/bsspirit/async_demo</a></p>
<p><strong>2). 下载async demo代码安装</strong></p>
<pre><code>
~ D:\workspace\javascript>git clone git@github.com:bsspirit/async_demo.git nodejs-async
~ D:\workspace\javascript>cd nodejs-async
~ D:\workspace\javascript\nodejs-async>npm install
npm http GET https://registry.npmjs.org/moment
npm http GET https://registry.npmjs.org/async
npm http 304 https://registry.npmjs.org/moment
npm http 304 https://registry.npmjs.org/async
async@0.2.9 node_modules\async
moment@2.1.0 node_modules\moment
</code></pre>
<p>这套demo示例，比较全面的介绍了async的使用，有中文注释。 感谢github社区原创作者freewind，代码更新的贡献者alsotang。</p>
<p>当然，我的分支中也修改了一部分代码。在本文最后，我会写到changelog中！</p>
<h2>3. Async函数介绍</h2>
<p>基于async的0.2.9版本。</p>
<p><strong>async主要实现了三个部分的流程控制功能：</strong></p>
<ul>
<li>集合: Collections</li>
<li>流程控制: Control Flow</li>
<li>工具类: Utils</li>
</ul>
<p><strong>1). 集合: Collections</strong></p>
<ul>
<li>each: 如果想对同一个集合中的所有元素都执行同一个异步操作。</li>
<li>map: 对集合中的每一个元素，执行某个异步操作，得到结果。所有的结果将汇总到最终的callback里。与each的区别是，each只关心操作不管最后的值，而map关心的最后产生的值。</li>
<li>filter: 使用异步操作对集合中的元素进行筛选, 需要注意的是，iterator的callback只有一个参数，只能接收true或false。</li>
<li>reject: reject跟filter正好相反，当测试为true时则抛弃</li>
<li>reduce: 可以让我们给定一个初始值，用它与集合中的每一个元素做运算，最后得到一个值。reduce从左向右来遍历元素，如果想从右向左，可使用reduceRight。</li>
<li>detect: 用于取得集合中满足条件的第一个元素。</li>
<li>sortBy: 对集合内的元素进行排序，依据每个元素进行某异步操作后产生的值，从小到大排序。</li>
<li>some: 当集合中是否有至少一个元素满足条件时，最终callback得到的值为true，否则为false.</li>
<li>every: 如果集合里每一个元素都满足条件，则传给最终回调的result为true，否则为false</li>
<li>concat: 将多个异步操作的结果合并为一个数组。</li>
</ul>
<p><strong>2). 流程控制: Control Flow</strong></p>
<ul>
<li>series: 串行执行，一个函数数组中的每个函数，每一个函数执行完成之后才能执行下一个函数。</li>
<li>parallel: 并行执行多个函数，每个函数都是立即执行，不需要等待其它函数先执行。传给最终callback的数组中的数据按照tasks中声明的顺序，而不是执行完成的顺序。</li>
<li>whilst: 相当于while，但其中的异步调用将在完成后才会进行下一次循环。</li>
<li>doWhilst: 相当于do&#8230;while, doWhilst交换了fn,test的参数位置，先执行一次循环，再做test判断。</li>
<li>until: until与whilst正好相反，当test为false时循环，与true时跳出。其它特性一致。</li>
<li>doUntil: doUntil与doWhilst正好相反，当test为false时循环，与true时跳出。其它特性一致。</li>
<li>forever: 无论条件循环执行，如果不出错，callback永远不被执行。</li>
<li>waterfall: 按顺序依次执行一组函数。每个函数产生的值，都将传给下一个。</li>
<li>compose: 创建一个包括一组异步函数的函数集合，每个函数会消费上一次函数的返回值。把f(),g(),h()异步函数，组合成f(g(h()))的形式，通过callback得到返回值。</li>
<li>applyEach: 实现给一数组中每个函数传相同参数，通过callback返回。如果只传第一个参数，将返回一个函数对象，我可以传参调用。</li>
<li>queue: 是一个串行的消息队列，通过限制了worker数量，不再一次性全部执行。当worker数量不够用时，新加入的任务将会排队等候，直到有新的worker可用。</li>
<li>cargo: 一个串行的消息队列，类似于queue，通过限制了worker数量，不再一次性全部执行。不同之处在于，cargo每次会加载满额的任务做为任务单元，只有任务单元中全部执行完成后，才会加载新的任务单元。</li>
<li>auto: 用来处理有依赖关系的多个任务的执行。</li>
<li>iterator: 将一组函数包装成为一个iterator，初次调用此iterator时，会执行定义中的第一个函数并返回第二个函数以供调用。</li>
<li>apply: 可以让我们给一个函数预绑定多个参数并生成一个可直接调用的新函数，简化代码。</li>
<li>nextTick: 与nodejs的nextTick一样，再最后调用函数。</li>
<li>times: 异步运行,times可以指定调用几次，并把结果合并到数组中返回</li>
<li>timesSeries: 与time类似，唯一不同的是同步执行</li>
</ul>
<p><strong>3). 工具类: Utils</strong></p>
<ul>
<li>memoize: 让某一个函数在内存中缓存它的计算结果。对于相同的参数，只计算一次，下次就直接拿到之前算好的结果。</li>
<li>unmemoize: 让已经被缓存的函数，返回不缓存的函数引用。</li>
<li>log: 执行某异步函数，并记录它的返回值，日志输出。</li>
<li>dir: 与log类似，不同之处在于，会调用浏览器的console.dir()函数，显示为DOM视图。</li>
<li>noConflict: 如果之前已经在全局域中定义了async变量，当导入本async.js时，会先把之前的async变量保存起来，然后覆盖它。仅仅用于浏览器端，在nodejs中没用，这里无法演示。</li>
</ul>
<h2>4. async_demo使用介绍</h2>
<p>详细使用请参考github源代码：<a target="_blank" href="https://github.com/bsspirit/async_demo" ref="nofollow">https://github.com/bsspirit/async_demo</a></p>
<p>每个函数的用法，有非常详细的实例！！</p>
<h2>5. 场景：对数据库的连续操作</h2>
<p>这个场景进背景情况，请参考文章：<a href="http://blog.fens.me/nodejs-mysql-intro/" title="用Nodejs连接MySQL" target="_blank">用Nodejs连接MySQL</a></p>
<p>原场景中，对数据串行操作，增删改查(CRUD)，代码如下：</p>
<pre><code>
var mysql = require('mysql');
var conn = mysql.createConnection({
    host: 'localhost',
    user: 'nodejs',
    password: 'nodejs',
    database: 'nodejs',
    port: 3306
});
conn.connect();

var insertSQL = 'insert into t_user(name) values("conan"),("fens.me")';
var selectSQL = 'select * from t_user limit 10';
var deleteSQL = 'delete from t_user';
var updateSQL = 'update t_user set name="conan update"  where name="conan"';

//delete
conn.query(deleteSQL, function (err0, res0) {
    if (err0) console.log(err0);
    console.log("DELETE Return ==> ");
    console.log(res0);

    //insert
    conn.query(insertSQL, function (err1, res1) {
        if (err1) console.log(err1);
        console.log("INSERT Return ==> ");
        console.log(res1);

        //query
        conn.query(selectSQL, function (err2, rows) {
            if (err2) console.log(err2);

            console.log("SELECT ==> ");
            for (var i in rows) {
                console.log(rows[i]);
            }

            //update
            conn.query(updateSQL, function (err3, res3) {
                if (err3) console.log(err3);
                console.log("UPDATE Return ==> ");
                console.log(res3);

                //query
                conn.query(selectSQL, function (err4, rows2) {
                    if (err4) console.log(err4);

                    console.log("SELECT ==> ");
                    for (var i in rows2) {
                        console.log(rows2[i]);
                    }
                });
            });
        });
    });
});

//conn.end();
</code></pre>
<p>为了实现了串行操作，所有的调用都是在callback中实现的，5层嵌套结构。这种代码已经变得不可以维护了。所以，需要用async库，对上面的代码结构进行重写！</p>
<p><strong>修改后的代码</strong></p>
<pre><code>
var mysql = require('mysql');
var async = require('async');

var conn = mysql.createConnection({
    host: 'localhost',
    user: 'nodejs',
    password: 'nodejs',
    database: 'nodejs',
    port: 3306
});

var sqls = {
    'insertSQL': 'insert into t_user(name) values("conan"),("fens.me")',
    'selectSQL': 'select * from t_user limit 10',
    'deleteSQL': 'delete from t_user',
    'updateSQL': 'update t_user set name="conan update"  where name="conan"'
};

var tasks = ['deleteSQL', 'insertSQL', 'selectSQL', 'updateSQL', 'selectSQL'];
async.eachSeries(tasks, function (item, callback) {
    console.log(item + " ==> " + sqls[item]);
    conn.query(sqls[item], function (err, res) {
        console.log(res);
        callback(err, res);
    });
}, function (err) {
    console.log("err: " + err);
});
</code></pre>
<p><strong>控制台输出</strong></p>
<pre><code>
deleteSQL ==> delete from t_user
{ fieldCount: 0,
  affectedRows: 0,
  insertId: 0,
  serverStatus: 34,
  warningCount: 0,
  message: '',
  protocol41: true,
  changedRows: 0 }
insertSQL ==> insert into t_user(name) values("conan"),("fens.me")
{ fieldCount: 0,
  affectedRows: 2,
  insertId: 45,
  serverStatus: 2,
  warningCount: 0,
  message: '&Records: 2  Duplicates: 0  Warnings: 0',
  protocol41: true,
  changedRows: 0 }
selectSQL ==> select * from t_user limit 10
[ { id: 45,
    name: 'conan',
    create_date: Fri Sep 13 2013 12:24:51 GMT+0800 (中国标准时间) },
  { id: 46,
    name: 'fens.me',
    create_date: Fri Sep 13 2013 12:24:51 GMT+0800 (中国标准时间) } ]
updateSQL ==> update t_user set name="conan update"  where name="conan"
{ fieldCount: 0,
  affectedRows: 1,
  insertId: 0,
  serverStatus: 2,
  warningCount: 0,
  message: '(Rows matched: 1  Changed: 1  Warnings: 0',
  protocol41: true,
  changedRows: 1 }
selectSQL ==> select * from t_user limit 10
[ { id: 45,
    name: 'conan update',
    create_date: Fri Sep 13 2013 12:24:51 GMT+0800 (中国标准时间) },
  { id: 46,
    name: 'fens.me',
    create_date: Fri Sep 13 2013 12:24:51 GMT+0800 (中国标准时间) } ]
err: null
</code></pre>
<p>代码一下读性就增强了许多倍，这就是高效的开发。</p>
<p>不用不知道，一用真强大！！！</p>
<p>当然还有其他的工作流框架来完成这件事情step,then.js,windjs。<br />
windjs请参考：<a title="wind.js助力异步编程" href="http://blog.fens.me/nodejs-async-windjs/" target="_blank">wind.js助力异步编程</a></p>
<h2>6. async_demo我的分支</h2>
<p><a href="https://github.com/bsspirit/async_demo" target="_blank" ref="nofollow">https://github.com/bsspirit/async_demo</a></p>
<ul>
<li>1. forEach.js改名为each.js</li>
<li>2. each.js文件中的async.forEach，改为async.each</li>
<li>3. map.js增加mapLimit函数</li>
<li>4. filter_reject.js对注释补充</li>
<li>5. filter_reject.js增加rejectSeries函数</li>
<li>6. reduce.js增加注释</li>
<li>7. detect.js增加注释</li>
<li>8. sortBy.js增加注释</li>
<li>9. some.js对注释补充</li>
<li>10. every.js对注释补充和修改</li>
<li>11. series.js调整注释格式</li>
<li>12. parallel.js调整注释格式</li>
<li>13. parallel.js增加parallelLimit函数</li>
<li>14. whilist_until.js调整注释格式</li>
<li>15. whilist_until.js增加doWhilst函数</li>
<li>16. whilist_until.js增加doUntil函数</li>
<li>17. whilist_until.js增加forever函数</li>
<li>18. waterfall.js调整注释格式</li>
<li>19. 增加compose.js文件</li>
<li>20. apply.js补充注释并增加一个实例</li>
<li>21. 修改nextTick.js实例</li>
<li>22. 增加times.js文件，包括times和timesSeries函数</li>
<li>23. 修改iterator.js实例</li>
<li>24. 修正auto.js关于第二个实例的错误解释</li>
<li>25. 修改queue.js实例和注释</li>
<li>26. 修改cargo.js文件</li>
<li>27. 增加applyEach.js文件</li>
<li>28. 修改utils.js实例和注释</li>
</ul>
<p><strong>转载请注明出处：</strong><br />
<a title="Nodejs异步流程控制Async" href="http://blog.fens.me/nodejs-async/" target="_blank">http://blog.fens.me/nodejs-async/</a></p>
<p><img src="http://blog.fens.me/wp-content/uploads/2016/04/pay50.png" alt="打赏作者" width="600" height="400" class="alignnone size-full wp-image-8388"></p>
              <div class="clear"></div>
                            <p class="inner-meta">This entry was posted in <a href="http://blog.fens.me/category/javascript%e8%af%ad%e8%a8%80%e5%ae%9e%e8%b7%b5/" rel="category tag">Javascript语言实践</a>, <a href="http://blog.fens.me/category/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1/" rel="category tag">架构设计</a></p>              
            </div>
            <!-- 广告 -->
            <div id="ads"></div>        
            <div class="post comments" id="comments">              
                
<div id="disqus_thread">
            <div id="dsq-content">


            <ul id="dsq-comments">
                    <li class="post pingback">
        <p>Pingback: <a href='http://blog.fens.me/nodejs-async-timer/' rel='external nofollow' class='url'>Async多任务时间管理 | 粉丝日志</a>()</p>
    </li>
    </li><!-- #comment-## -->
    <li class="comment even thread-even depth-1" id="dsq-comment-1325">
        <div id="dsq-comment-header-1325" class="dsq-comment-header">
            <cite id="dsq-cite-1325">
                <span id="dsq-author-user-1325">anota</span>
            </cite>
        </div>
        <div id="dsq-comment-body-1325" class="dsq-comment-body">
            <div id="dsq-comment-message-1325" class="dsq-comment-message"><p>靠谱，之前也用过windjs，后来发现不维护了，一直没关注流程控制的库，妈妈再也不用担心我异步恶心的代码了。</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-1326">
        <div id="dsq-comment-header-1326" class="dsq-comment-header">
            <cite id="dsq-cite-1326">
                <a id="dsq-author-user-1326" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-1326" class="dsq-comment-body">
            <div id="dsq-comment-message-1326" class="dsq-comment-message"><p>windjs我之前也用了，确实比async相差的有点远。</p>
</div>
        </div>

    <ul class="children">
    <li class="comment even depth-3" id="dsq-comment-1338">
        <div id="dsq-comment-header-1338" class="dsq-comment-header">
            <cite id="dsq-cite-1338">
                <span id="dsq-author-user-1338">anota</span>
            </cite>
        </div>
        <div id="dsq-comment-body-1338" class="dsq-comment-body">
            <div id="dsq-comment-message-1338" class="dsq-comment-message"><p>最近看了一下koa 发现有了generator 不用async也可以，再简单封装一下，不知道你有没有koa的实践呢，最近刚上手一些web实验项目，在纠结框架中</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-4" id="dsq-comment-1340">
        <div id="dsq-comment-header-1340" class="dsq-comment-header">
            <cite id="dsq-cite-1340">
                <a id="dsq-author-user-1340" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-1340" class="dsq-comment-body">
            <div id="dsq-comment-message-1340" class="dsq-comment-message"><p>我没有用koa，express+angular已经能解决我的问题了。</p>
</div>
        </div>

    <ul class="children">
    <li class="comment even depth-5" id="dsq-comment-1350">
        <div id="dsq-comment-header-1350" class="dsq-comment-header">
            <cite id="dsq-cite-1350">
                <span id="dsq-author-user-1350">anota</span>
            </cite>
        </div>
        <div id="dsq-comment-body-1350" class="dsq-comment-body">
            <div id="dsq-comment-message-1350" class="dsq-comment-message"><p>angular总感觉还是得引入一个zepto或jquery，有一些复杂的dom操作，controller没法实现，用指令的时候自带的jquery lite还是太简陋了。不知道你是否遇到这样的瓶颈，引进jquery又很不爽，然后各种纠结。</p>
</div>
        </div>

    </li><!-- #comment-## -->
    <li class="comment odd alt depth-5" id="dsq-comment-1351">
        <div id="dsq-comment-header-1351" class="dsq-comment-header">
            <cite id="dsq-cite-1351">
                <a id="dsq-author-user-1351" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-1351" class="dsq-comment-body">
            <div id="dsq-comment-message-1351" class="dsq-comment-message"><p>1. angular配合 jquery一起用是没有问题的<br />
2. 要定义好使用的规则，比如只用jquery做dom操作。<br />
3. 当dom操作可以标准化的时候，用Directive封装</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-1337">
        <div id="dsq-comment-header-1337" class="dsq-comment-header">
            <cite id="dsq-cite-1337">
                <span id="dsq-author-user-1337">anota</span>
            </cite>
        </div>
        <div id="dsq-comment-body-1337" class="dsq-comment-body">
            <div id="dsq-comment-message-1337" class="dsq-comment-message"><p>期待有koa的实践</p>
</div>
        </div>

    </li><!-- #comment-## -->
    <li class="comment odd alt thread-even depth-1" id="dsq-comment-2347">
        <div id="dsq-comment-header-2347" class="dsq-comment-header">
            <cite id="dsq-cite-2347">
                <span id="dsq-author-user-2347">rookie</span>
            </cite>
        </div>
        <div id="dsq-comment-body-2347" class="dsq-comment-body">
            <div id="dsq-comment-message-2347" class="dsq-comment-message"><p>我想问下我用循环填充数组的时候，再执行流程会产生闭包问题</p>
<p>但我用闭包方法解决，打印出数组是[undefine,undefine]，什么情况</p>
</div>
        </div>

    <ul class="children">
    <li class="comment even depth-2" id="dsq-comment-3771">
        <div id="dsq-comment-header-3771" class="dsq-comment-header">
            <cite id="dsq-cite-3771">
                <span id="dsq-author-user-3771">17007325</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3771" class="dsq-comment-body">
            <div id="dsq-comment-message-3771" class="dsq-comment-message"><p>请教一下，你的闭包如何写的，有联系方式吗，我QQ 17007325</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment odd alt thread-odd thread-alt depth-1" id="dsq-comment-2869">
        <div id="dsq-comment-header-2869" class="dsq-comment-header">
            <cite id="dsq-cite-2869">
                <span id="dsq-author-user-2869">宋谭</span>
            </cite>
        </div>
        <div id="dsq-comment-body-2869" class="dsq-comment-body">
            <div id="dsq-comment-message-2869" class="dsq-comment-message"><p><a href="http://www.hubwiz.com/course/543e1a4f032c7816c0d5dfa1" rel="nofollow">http://www.hubwiz.com/course/543e1a4f032c7816c0d5dfa1</a>  楼主看看我写的async 异步编程课程，给提一些建议</p>
</div>
        </div>

    <ul class="children">
    <li class="comment even depth-2" id="dsq-comment-2871">
        <div id="dsq-comment-header-2871" class="dsq-comment-header">
            <cite id="dsq-cite-2871">
                <a id="dsq-author-user-2871" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-2871" class="dsq-comment-body">
            <div id="dsq-comment-message-2871" class="dsq-comment-message"><p>似乎不能直接看。</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-3" id="dsq-comment-2881">
        <div id="dsq-comment-header-2881" class="dsq-comment-header">
            <cite id="dsq-cite-2881">
                <span id="dsq-author-user-2881">宋谭</span>
            </cite>
        </div>
        <div id="dsq-comment-body-2881" class="dsq-comment-body">
            <div id="dsq-comment-message-2881" class="dsq-comment-message"><p>恩 需要登陆才能看到</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-even depth-1" id="dsq-comment-2907">
        <div id="dsq-comment-header-2907" class="dsq-comment-header">
            <cite id="dsq-cite-2907">
                <span id="dsq-author-user-2907">Zhiqiang Zhang</span>
            </cite>
        </div>
        <div id="dsq-comment-body-2907" class="dsq-comment-body">
            <div id="dsq-comment-message-2907" class="dsq-comment-message"><p>Conan, 我在写node.js的时候发现，虽然node.js在每个单个访问的内部计算是异步的（比如有多个数据库查询，对结果的处理可以做到异步）。但在不同访问之间完全是阻塞的，即后一个访问要等到前一个访问的处理完全结束之后才会开始计算（比如发送数据库查询命令）。我想知道，这个���node.js就是这么设计的，还是我程序哪个地方写得不对呢？</p>
<p>我用的是express框架。我做的事情也比较简单，就是查询几条数据库语句，然后把结果拼起来显示出来。</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-2915">
        <div id="dsq-comment-header-2915" class="dsq-comment-header">
            <cite id="dsq-cite-2915">
                <a id="dsq-author-user-2915" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-2915" class="dsq-comment-body">
            <div id="dsq-comment-message-2915" class="dsq-comment-message"><p>我在测试的时候，所有的SQL操作都是异步的，因此需要用async流程控制框架进行封装。</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-3152">
        <div id="dsq-comment-header-3152" class="dsq-comment-header">
            <cite id="dsq-cite-3152">
                <span id="dsq-author-user-3152">heliosliu</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3152" class="dsq-comment-body">
            <div id="dsq-comment-message-3152" class="dsq-comment-message"><p>parallel这个函数中，如何给task设置超时时间呢</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3183">
        <div id="dsq-comment-header-3183" class="dsq-comment-header">
            <cite id="dsq-cite-3183">
                <a id="dsq-author-user-3183" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-3183" class="dsq-comment-body">
            <div id="dsq-comment-message-3183" class="dsq-comment-message"><p>Demo里，应该有写吧。如果原生函数没有，那么自己做个timeout回调吧。</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-even depth-1" id="dsq-comment-3154">
        <div id="dsq-comment-header-3154" class="dsq-comment-header">
            <cite id="dsq-cite-3154">
                <span id="dsq-author-user-3154">宋谭</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3154" class="dsq-comment-body">
            <div id="dsq-comment-message-3154" class="dsq-comment-message"><p>真的很不错 学习了。</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3182">
        <div id="dsq-comment-header-3182" class="dsq-comment-header">
            <cite id="dsq-cite-3182">
                <a id="dsq-author-user-3182" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-3182" class="dsq-comment-body">
            <div id="dsq-comment-message-3182" class="dsq-comment-message"><p>🙂</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-3553">
        <div id="dsq-comment-header-3553" class="dsq-comment-header">
            <cite id="dsq-cite-3553">
                <span id="dsq-author-user-3553">cc</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3553" class="dsq-comment-body">
            <div id="dsq-comment-message-3553" class="dsq-comment-message"><p>请教下，能用 async 外理中间件么？</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3567">
        <div id="dsq-comment-header-3567" class="dsq-comment-header">
            <cite id="dsq-cite-3567">
                <a id="dsq-author-user-3567" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-3567" class="dsq-comment-body">
            <div id="dsq-comment-message-3567" class="dsq-comment-message"><p>没看懂你的问题？</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-even depth-1" id="dsq-comment-3560">
        <div id="dsq-comment-header-3560" class="dsq-comment-header">
            <cite id="dsq-cite-3560">
                <span id="dsq-author-user-3560">wmzy</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3560" class="dsq-comment-body">
            <div id="dsq-comment-message-3560" class="dsq-comment-message"><p>您好,请教下：<br />
使用async什么情况下需要限制并发数？并发数应该依据什么来定量？</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3568">
        <div id="dsq-comment-header-3568" class="dsq-comment-header">
            <cite id="dsq-cite-3568">
                <a id="dsq-author-user-3568" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-3568" class="dsq-comment-body">
            <div id="dsq-comment-message-3568" class="dsq-comment-message"><p>async框架本身任何操作都不用限制异步并发数，就像timeout(func,time)使用一样。<br />
衡量标准，我觉得是你的CPU负载情况。</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-3669">
        <div id="dsq-comment-header-3669" class="dsq-comment-header">
            <cite id="dsq-cite-3669">
                <span id="dsq-author-user-3669">wujohns</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3669" class="dsq-comment-body">
            <div id="dsq-comment-message-3669" class="dsq-comment-message"><p>我自己在使用async.eachSeries，结果只会执行第一个task，如果是本文的例子那么只会执行deleteSQL ==&gt; delete from t_user这个task，这个这么办，是固有的bug吗？</p>
</div>
        </div>

    </li><!-- #comment-## -->
    <li class="comment odd alt thread-even depth-1" id="dsq-comment-3670">
        <div id="dsq-comment-header-3670" class="dsq-comment-header">
            <cite id="dsq-cite-3670">
                <span id="dsq-author-user-3670">wujohns</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3670" class="dsq-comment-body">
            <div id="dsq-comment-message-3670" class="dsq-comment-message"><p>我试过博文中的这个例子，结果只能执行第一个task</p>
</div>
        </div>

    </li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-3671">
        <div id="dsq-comment-header-3671" class="dsq-comment-header">
            <cite id="dsq-cite-3671">
                <span id="dsq-author-user-3671">wujohns</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3671" class="dsq-comment-body">
            <div id="dsq-comment-message-3671" class="dsq-comment-message"><p>找到问题了，那个eachSeries应该是every，不知道是不是版本变更。。。。</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3677">
        <div id="dsq-comment-header-3677" class="dsq-comment-header">
            <cite id="dsq-cite-3677">
                <a id="dsq-author-user-3677" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-3677" class="dsq-comment-body">
            <div id="dsq-comment-message-3677" class="dsq-comment-message"><p>嗯，要查一下API细节信息。</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-even depth-1" id="dsq-comment-3688">
        <div id="dsq-comment-header-3688" class="dsq-comment-header">
            <cite id="dsq-cite-3688">
                <span id="dsq-author-user-3688">hello</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3688" class="dsq-comment-body">
            <div id="dsq-comment-message-3688" class="dsq-comment-message"><p>我有个疑惑啊，node的优势不就是异步，处理高并发什么的，可是<br />
有的时候我需要等回调结果，我就要用async排队执行，那不就没优势了吗<br />
那么多回调还好烦</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3691">
        <div id="dsq-comment-header-3691" class="dsq-comment-header">
            <cite id="dsq-cite-3691">
                <a id="dsq-author-user-3691" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-3691" class="dsq-comment-body">
            <div id="dsq-comment-message-3691" class="dsq-comment-message"><p>1. Node是异步回调模型，但有些业务是需要同步操作的，所以会出现async这类框架。<br />
2. 不能说明，少量的同步代码，就会降低整体系统的运行效率。<br />
3. 作为开发人员，要把 同步和异步 代码配合用好，才能又提高开发效率的同时保证运行效率。</p>
</div>
        </div>

    </li><!-- #comment-## -->
    <li class="comment even depth-2" id="dsq-comment-3850">
        <div id="dsq-comment-header-3850" class="dsq-comment-header">
            <cite id="dsq-cite-3850">
                <span id="dsq-author-user-3850">lezi2012</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3850" class="dsq-comment-body">
            <div id="dsq-comment-message-3850" class="dsq-comment-message"><p>看你的业务场景是否允许异步吧，如果允许那就不要同步去做了，异步更快，如果场景要求同步，比如 先算一下账户余额，如果余额足够则进行打款，这样的顺序是无法异步的，如果是nodejs 写的程序，就需要同步一下两个动作了。</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment odd alt thread-odd thread-alt depth-1" id="dsq-comment-3770">
        <div id="dsq-comment-header-3770" class="dsq-comment-header">
            <cite id="dsq-cite-3770">
                <span id="dsq-author-user-3770">feiyang</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3770" class="dsq-comment-body">
            <div id="dsq-comment-message-3770" class="dsq-comment-message"><p>请教一下async.parallel 结合 闭包如何使用?  </p>
<p>var tt = [];</p>
<p>var ops = [];</p>
<p>for(var i = 0;i &lt; tt.length; i++){</p>
<p>     ops.put(<br />
        (function(callback){<br />
            callback(null, i);<br />
       })(i)<br />
   );<br />
}</p>
<p>async.parallel(ops , function (err, results) { &#8230; });</p>
<p>提示错误： number is not function</p>
</div>
        </div>

    <ul class="children">
    <li class="comment even depth-2" id="dsq-comment-3781">
        <div id="dsq-comment-header-3781" class="dsq-comment-header">
            <cite id="dsq-cite-3781">
                <a id="dsq-author-user-3781" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-3781" class="dsq-comment-body">
            <div id="dsq-comment-message-3781" class="dsq-comment-message"><p>闭包是异步的，一般用async就不要自己再写闭包了。</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment odd alt thread-even depth-1" id="dsq-comment-3975">
        <div id="dsq-comment-header-3975" class="dsq-comment-header">
            <cite id="dsq-cite-3975">
                <span id="dsq-author-user-3975">cc</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3975" class="dsq-comment-body">
            <div id="dsq-comment-message-3975" class="dsq-comment-message"><p>请教下，map 是并行还是串行？</p>
</div>
        </div>

    </li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-4115">
        <div id="dsq-comment-header-4115" class="dsq-comment-header">
            <cite id="dsq-cite-4115">
                <span id="dsq-author-user-4115">庞国明</span>
            </cite>
        </div>
        <div id="dsq-comment-body-4115" class="dsq-comment-body">
            <div id="dsq-comment-message-4115" class="dsq-comment-message"><p>有没有 bluebird 异步重构的文章？ 国外测评说bluebird 性能最好</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-4117">
        <div id="dsq-comment-header-4117" class="dsq-comment-header">
            <cite id="dsq-cite-4117">
                <a id="dsq-author-user-4117" href="http://blog.fens.me/" target="_blank" rel="nofollow">Conan Zhang</a>
            </cite>
        </div>
        <div id="dsq-comment-body-4117" class="dsq-comment-body">
            <div id="dsq-comment-message-4117" class="dsq-comment-message"><p>google找吧，我没有用过bluebird</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-even depth-1" id="dsq-comment-5319">
        <div id="dsq-comment-header-5319" class="dsq-comment-header">
            <cite id="dsq-cite-5319">
                <span id="dsq-author-user-5319">黃冠儒</span>
            </cite>
        </div>
        <div id="dsq-comment-body-5319" class="dsq-comment-body">
            <div id="dsq-comment-message-5319" class="dsq-comment-message"><p>请教一下，改写后的代码是不是少了conn.connect();</p>
</div>
        </div>

    </li><!-- #comment-## -->
            </ul>


        </div>

    </div>

<script type="text/javascript">
var disqus_url = 'http://blog.fens.me/nodejs-async/';
var disqus_identifier = '2357 http://blog.fens.me/?p=2357';
var disqus_container_id = 'disqus_thread';
var disqus_shortname = 'bsspirit';
var disqus_title = "Nodejs异步流程控制Async";
var disqus_config_custom = window.disqus_config;
var disqus_config = function () {
    /*
    All currently supported events:
    onReady: fires when everything is ready,
    onNewComment: fires when a new comment is posted,
    onIdentify: fires when user is authenticated
    */
    
    
    this.language = '';
        this.callbacks.onReady.push(function () {

        // sync comments in the background so we don't block the page
        var script = document.createElement('script');
        script.async = true;
        script.src = '?cf_action=sync_comments&post_id=2357';

        var firstScript = document.getElementsByTagName('script')[0];
        firstScript.parentNode.insertBefore(script, firstScript);
    });
    
    if (disqus_config_custom) {
        disqus_config_custom.call(this);
    }
};

(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>

            </div>
          </div>
       </div>
    
</div> <!-- END Narrowcolumn -->

<div id="sidebar" class="profile">
 <ul>
<li id="widget_nav_menu" class="widget png_scale"><h2 class="blocktitle"><span>站内导航</span></h2><div class="menu-menu-1-container"><ul id="menu-menu-1" class="menu"><li id="menu-item-2328" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2328"><a href="http://blog.fens.me/series-r/">R的极客理想系列文章</a></li>
<li id="menu-item-2329" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2329"><a href="http://blog.fens.me/series-nodejs/">从零开始nodejs系列文章</a></li>
<li id="menu-item-2338" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2338"><a href="http://blog.fens.me/series-it-finance/">用IT技术玩金融系列文章</a></li>
<li id="menu-item-6505" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6505"><a href="http://blog.fens.me/series-meeting/">跨界知识聚会系列文章</a></li>
<li id="menu-item-2339" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2339"><a href="http://blog.fens.me/series-hadoop-family/">Hadoop家族系列文章</a></li>
<li id="menu-item-2337" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2337"><a href="http://blog.fens.me/series-angular/">AngularJS体验式编程系列文章</a></li>
<li id="menu-item-2331" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2331"><a href="http://blog.fens.me/series-rhadoop/">RHadoop实践系列文章</a></li>
<li id="menu-item-2330" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2330"><a href="http://blog.fens.me/series-java/">无所不能的Java系列文章</a></li>
<li id="menu-item-2336" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2336"><a href="http://blog.fens.me/series-ubuntu/">ubuntu实用工具系列文章</a></li>
<li id="menu-item-2332" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2332"><a href="http://blog.fens.me/series-r-nosql/">R利剑NoSQL系列文章</a></li>
<li id="menu-item-2334" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2334"><a href="http://blog.fens.me/series-mongodb/">MongoDB部署实验系列文章</a></li>
<li id="menu-item-2335" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2335"><a href="http://blog.fens.me/series-hadoop-cloud/">让Hadoop跑在云端系列文章</a></li>
<li id="menu-item-2333" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2333"><a href="http://blog.fens.me/series-vps/">自己搭建VPS系列文章</a></li>
<li id="menu-item-5469" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5469"><a href="http://blog.fens.me/series-architect/">架构师的信仰系列文章</a></li>
<li id="menu-item-4163" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4163"><a href="http://blog.fens.me/series-algorithm/">算法为王系列文章</a></li>
<li id="menu-item-8189" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8189"><a href="http://blog.fens.me/series-seo/">我的博客我的SEO系列文章</a></li>
<li id="menu-item-2340" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2340"><a href="http://blog.fens.me/series-visualisation/">创造可视化系列文章</a></li>
<li id="menu-item-7694" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7694"><a href="http://blog.fens.me/series-startup/">创业者的囧境系列文章</a></li>
<li id="menu-item-8842" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8842"><a href="http://blog.fens.me/tasks/">写作计划列表</a></li>
<li id="menu-item-2342" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2342"><a href="http://blog.fens.me/about/">关于站长</a></li>
<li id="menu-item-8175" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8175"><a href="http://blog.fens.me/ad/">投放广告</a></li>
</ul></div></li><li id="widget_recent_comments" class="widget png_scale"><h2 class="blocktitle"><span>最新评论</span></h2><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link">Rachel Wijaya</span> on <a href="http://blog.fens.me/hexo-blog-github/#comment-5579">Hexo在github上构建免费的Web应用</a></li><li class="recentcomments"><span class="comment-author-link">Vincent</span> on <a href="http://blog.fens.me/hadoop-mapreduce-matrix/#comment-5576">用MapReduce实现矩阵乘法</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://www.flyfishonline.com/' rel='external nofollow' class='url'>BabyGo</a></span> on <a href="http://blog.fens.me/r-docker/#comment-5572">当R语言遇上Docker</a></li><li class="recentcomments"><span class="comment-author-link">xp Wan</span> on <a href="http://blog.fens.me/linux-mysql-install/#comment-5571">在Ubuntu中安装MySQL</a></li><li class="recentcomments"><span class="comment-author-link">Kang Ji</span> on <a href="http://blog.fens.me/finance-pairs-trading/#comment-5566">R语言构建配对交易量化模型</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://blog.fens.me/' rel='external nofollow' class='url'>Conan Zhang</a></span> on <a href="http://blog.fens.me/finance-pairs-trading/#comment-5565">R语言构建配对交易量化模型</a></li><li class="recentcomments"><span class="comment-author-link">唐國淯</span> on <a href="http://blog.fens.me/finance-pairs-trading/#comment-5559">R语言构建配对交易量化模型</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://blog.fens.me/architect-next/' rel='external nofollow' class='url'>技术大牛如何寻找下���个风口 | 粉丝日志</a></span> on <a href="http://blog.fens.me/series-architect/#comment-5534">架构师的信仰系列文章</a></li><li class="recentcomments"><span class="comment-author-link">杨俊林</span> on <a href="http://blog.fens.me/nodejs-email-nodemailer/#comment-5526">Nodejs发邮件组件Nodemailer</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://blog.fens.me/' rel='external nofollow' class='url'>Conan Zhang</a></span> on <a href="http://blog.fens.me/nodejs-core-domain/#comment-5520">Nodejs异步异常处理domain</a></li><li class="recentcomments"><span class="comment-author-link">Sam Hu</span> on <a href="http://blog.fens.me/nodejs-core-domain/#comment-5517">Nodejs异步异常处理domain</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://github.com/lgh06' rel='external nofollow' class='url'>HapLeo</a></span> on <a href="http://blog.fens.me/startup-registration/#comment-5512">新公司注册流程</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://github.com/lgh06' rel='external nofollow' class='url'>HapLeo</a></span> on <a href="http://blog.fens.me/series-it-finance/#comment-5511">用IT技术玩金融系列文章</a></li><li class="recentcomments"><span class="comment-author-link">杨镇铭</span> on <a href="http://blog.fens.me/r-multi-linear-regression/#comment-5508">R语言解读多元线性回归模型</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://blog.fens.me/' rel='external nofollow' class='url'>Conan Zhang</a></span> on <a href="http://blog.fens.me/r-apply/#comment-5507">掌握R语言中的apply函数族</a></li></ul></li>		<li id="widget_recent_entries" class="widget png_scale">		<h2 class="blocktitle"><span>最新文章</span></h2>		<ul>
					<li>
				<a href="http://blog.fens.me/architect-next/">技术大牛如何寻找下一个风口</a>
						</li>
					<li>
				<a href="http://blog.fens.me/architect-algorithm/">算法，如何改变命运</a>
						</li>
					<li>
				<a href="http://blog.fens.me/angular2-init/">Angular2新的体验</a>
						</li>
					<li>
				<a href="http://blog.fens.me/finance-capm/">R语言解读资本资产定价模型CAPM</a>
						</li>
					<li>
				<a href="http://blog.fens.me/finance-mojie/">用数据解读摩羯智投</a>
						</li>
					<li>
				<a href="http://blog.fens.me/meeting-softcon-20161210/">2016中国软件技术大会:用R语言进行投资组合管理</a>
						</li>
					<li>
				<a href="http://blog.fens.me/meeting-iais-20161125/">2016IAIS人工智能产业论坛:用R语言进行投资组合管理</a>
						</li>
					<li>
				<a href="http://blog.fens.me/meeting-cdas-20160903/">2016CDAS中国数据分析师行业峰会:如何用R语言进行量化分析</a>
						</li>
					<li>
				<a href="http://blog.fens.me/r-docker/">当R语言遇上Docker</a>
						</li>
					<li>
				<a href="http://blog.fens.me/linux-docker-install/">在Ubuntu中安装Docker</a>
						</li>
					<li>
				<a href="http://blog.fens.me/r-ar/">R语言解读自回归模型</a>
						</li>
					<li>
				<a href="http://blog.fens.me/r-quant-packages/">R语言量化投资常用包总结</a>
						</li>
					<li>
				<a href="http://blog.fens.me/r-cpp-rcpp/">R语言跨界调用C++</a>
						</li>
					<li>
				<a href="http://blog.fens.me/r-multi-linear-regression/">R语言解读多元线性回归模型</a>
						</li>
					<li>
				<a href="http://blog.fens.me/r-linear-regression/">R语言解读一元线性回归模型</a>
						</li>
					<li>
				<a href="http://blog.fens.me/r-word-jiebar/">R语言中文分词包jiebaR</a>
						</li>
					<li>
				<a href="http://blog.fens.me/meeting-hellobi-20160701/">2016天善智能交流会第22场: R语言为量化而生</a>
						</li>
					<li>
				<a href="http://blog.fens.me/r-finance/">R语言为量化而生</a>
						</li>
					<li>
				<a href="http://blog.fens.me/r-data-table/">超高性能数据处理包data.table</a>
						</li>
					<li>
				<a href="http://blog.fens.me/r-apply/">掌握R语言中的apply函数族</a>
						</li>
				</ul>
		</li>		 
</ul></div>
<div class="clear"></div>

<div id="footer">
<div class="lt">Copyright &copy; 2017 All rights reserved.</div>
<div class="rt">Designed by <img src="http://blog.fens.me/wp-content/themes/silesia/images/natty-logo.png" width="82" height="17" valign="3px" class="png" alt="NattyWP" align="middle" /></div>		
<div class="clear"></div>			
</div>
    
</div>  
<div class="clear"></div>
</div><!-- END main wrapper -->

        <script type="text/javascript">
        // <![CDATA[
        var disqus_shortname = 'bsspirit';
        (function () {
            var nodes = document.getElementsByTagName('span');
            for (var i = 0, url; i < nodes.length; i++) {
                if (nodes[i].className.indexOf('dsq-postid') != -1 && nodes[i].parentNode.tagName == 'A') {
                    nodes[i].parentNode.setAttribute('data-disqus-identifier', nodes[i].getAttribute('data-dsqidentifier'));
                    url = nodes[i].parentNode.href.split('#', 1);
                    if (url.length == 1) { url = url[0]; }
                    else { url = url[1]; }
                    nodes[i].parentNode.href = url + '#disqus_thread';
                }
            }
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
        // ]]>
        </script>
        <script type="text/javascript" src="http://www.fens.me/js/google.js"></script>
<script type="text/javascript" src="http://www.fens.me/js/baidu.js"></script><script type="text/javascript" charset="utf-8">/*<![CDATA[*/ 
    jQuery(document).ready(function() {
        jQuery(".slideshow").cycle({
          fx: "turnDown",
          timeout: 6000,
          speed: 1000,
          prev: "#left-arrow",
          next: "#right-arrow",
          pagerEvent: "click",
          pauseOnPagerHover: true,
          cleartypeNoBg: true });						
      });
      /*]]>*/</script><script type='text/javascript' src='http://blog.fens.me/wp-includes/js/comment-reply.min.js?ver=4.7.4'></script>
<script type='text/javascript' src='http://blog.fens.me/wp-includes/js/wp-embed.min.js?ver=4.7.4'></script>
 
<script type="text/javascript" src="http://www.fens.me/js/ads.js"></script>
<script type="text/javascript" src="http://www.fens.me/js/google.js"></script>
<script type="text/javascript" src="http://www.fens.me/js/baidu.js"></script>

</body>
</html>